trigger:
  branches:
    include:
      - master

pool:
  name: selfhosted

variables:
  azureSubscription: 'arm service'
  acrName: 'lakshmanacr'
  imageName: 'grilli'
  tag: '$(Build.BuildId)'
  appName: 'grilli'

steps:

- checkout: self

# ðŸ”¹ Login to Azure and ACR
- task: AzureCLI@2
  displayName: 'Build and Push Image using Azure CLI'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az acr login --name $(acrName)

      docker build -t $(acrName).azurecr.io/$(imageName):$(tag) .

      docker push $(acrName).azurecr.io/$(imageName):$(tag)

# ðŸ”¹ Deploy Container to App Service
- task: AzureWebAppContainer@1
  displayName: 'Deploy to Web App'
  inputs:
    azureSubscription: '$(azureSubscription)'
    appName: '$(appName)'
    containers: '$(acrName).azurecr.io/$(imageName):$(tag)'
