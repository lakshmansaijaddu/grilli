trigger:
  branches:
    include:
      - master

pool:
  name: 'selfhosted'   # Your Windows agent pool name

variables:
  azureSubscription: 'arm service'

  # ACR
  acrName: 'lakshmanacr-fyeta6hma6ducah6'
  acrLoginServer: 'lakshmanacr-fyeta6hma6ducah6.azurecr.io'
  imageRepository: 'grilli'
  imageTag: '$(Build.BuildId)'

  # Azure Resources
  resourceGroup: 'DevOps'
  containerAppName: 'grilli'
  containerAppEnv: 'managedEnvironment-DevOps-b5f4'
  location: 'southindia'

steps:

# 1️⃣ Checkout code
- checkout: self

# 2️⃣ Build and Push Docker Image
- task: AzureCLI@2
  displayName: 'Build and Push Docker Image'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      Write-Host "Logging into ACR..."
      az acr login --name $(acrName)

      Write-Host "Building Docker image..."
      docker build -t $(acrLoginServer)/$(imageRepository):$(imageTag) .

      Write-Host "Pushing Docker image..."
      docker push $(acrLoginServer)/$(imageRepository):$(imageTag)

# 3️⃣ Create or Update Container App
- task: AzureCLI@2
  displayName: 'Deploy to Azure Container Apps'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |

      $appExists = az containerapp show `
        --name $(containerAppName) `
        --resource-group $(resourceGroup) `
        --query name `
        --output tsv 2>$null

      if (-not $appExists) {

          Write-Host "Creating Container App..."

          az containerapp create `
            --name $(containerAppName) `
            --resource-group $(resourceGroup) `
            --environment $(containerAppEnv) `
            --image $(acrLoginServer)/$(imageRepository):$(imageTag) `
            --registry-server $(acrLoginServer) `
            --target-port 80 `
            --ingress external `
            --cpu 0.5 `
            --memory 1.0Gi `
            --min-replicas 1 `
            --max-replicas 2

      } else {

          Write-Host "Updating Container App..."

          az containerapp update `
            --name $(containerAppName) `
            --resource-group $(resourceGroup) `
            --image $(acrLoginServer)/$(imageRepository):$(imageTag)
      }

      Write-Host "Fetching Application URL..."

      az containerapp show `
        --name $(containerAppName) `
        --resource-group $(resourceGroup) `
        --query properties.configuration.ingress.fqdn
